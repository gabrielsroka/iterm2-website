2022-02-17: Use promises for async selection. Issue 10155.

* Make copying big selections to the clipboard asynchronous
to avoid accidental hangs when you hit cmd-a.

* Fix a bug in copying with SGR codes where the params were
out of order and could end with 0, negating them.

* Add TerminalContentSnapshot, a handy object for accessing
the state of the terminal in the future. Thanks to
copy-on-write LineBuffer, making this is cheap.

* Add iTermRenegablePromise. Such a promise is created with
the capability of being "reneged". Invoking `renege` will
attempt to stop it and cause it to fail, but obviously there
are no guarantees since it's inherently racey. The purpose
is to avoid continuing to extract selections when a promise
is going to be discarded.

* Add the ability to wait on a promise, This is a little
risky because it could cause a deadlock, but I don't see a
better way to wait for a selection to be available when the
main thread needs it synchronously.

* Don't add selections over 1000 lines long to paste
history. Doing so would make it impossible to renege on copy
promises that could take a really long time to finish.

* Add nullability annotations to iTermTextExtractor.h.

* Add stopAsSoonAsPossible to iTermTextExtractor. It makes
content extraction stop wherever it is. This is to support
reneging selection promises.

2022-02-14: Fix a bug where the root terminal view's
iTermImageView was visible when there was no image

2022-02-14: Fix a bug where transparency is wrong initially.
Issue 10119

2022-02-14: Remove NSLog

2022-02-14: In legacy renderer, create a new background run
when faintness changes because fg & bg interact in this
case. Issue 10153

2022-02-14: Only jiggle on color change if bg or fg changes
darkness. Issue 9855

2022-02-13: Make search history completion work on a word
basis. Issue 10151

2022-02-13: Fix off-main-thread use of
iTermRateLimitedUpdate for idempotent timers that caused a
crash. Issue 10209

2022-02-13: Always respect newlines in set winicon/icon
title. Issue 10143

newline + subtitle -> change only subtitle title + newline
-> erase subtitle title -> change only title

Fixes a bug where setting the subtitle by control sequence
didn't take effect because we created a new swifty string
but the observer was run before the instance varible was
assigned to.

2022-02-11: Defer TIOCSWINSZ until we know the final size of
the window, in case you asked to make it bigger than macOS
allows. Issue 10134

2022-02-11: Don't try (and fail) to duplicate a tmux tab if
invoked by binding. Issue 10128

2022-02-11: Place the URL preview view in a location that
does not overlap the URL. Issue 10131

2022-02-11: Move setting the "did receive line feed" flag
into appendLineFeed so that code that prints tmux messages,
banners, etc. will get it. It's used for logging,
publishing, and pwd polling. Aside from wastefully doing
more pwd polling (which is already mitigated by rate
limiting) this fixes filtering on things like tmux gateways.

Avoid reentrant joined blocks switching to shared state when
already switched.

Fix a crash when copying color maps when state is joined.

2022-02-11: Optimize sendking keystrokes to tmux. Add
RunLengthEncoder to abstract grouping of similar sequential
elements

Based on https://github.com/gnachman/iTerm2/pull/459 by
Lonny Wong <lonnywong@qq.com>

2022-02-10: Don't remove selection when scrolling in
alternate screen mode while appending to history. Issue
10123

2022-02-10: Add a pref to preserve window spaces on
restoration. Issue 10087

2022-02-09: Don't crash if you click on an OSC 8 file: url
without a path. Issue 10121

2022-02-09: Always search automatically when the value on
the find pasteboard changes regardless of which view has
first responder. Issue 10103

2022-02-09: Fix warnings

2022-02-09: Fix bug where marks were vertically flipped in
GPU renderer

2022-02-09: Minor fixes

2022-02-09: Convert most joined side effects into unmanaged
side effects to eliminate side-effect reentrancy as much as
possible.

Fix screenSetTabColorRedComponentTo, which actually changed
blue.

2022-02-09: Fix various cases where the main thread got
access to non-doppelganger interval tree objects.

Avoid calling -refresh in joined side blocks to reduce
reentrancy.

Avoid looking up interval tree objects in side effects
because things may have changed since the side effect was
added. For example, screenCurrentDirectroydDidChangeTo: now
takes the remoteHost instead of looking it up.

Remove spurious assertions that
performBlockWithJoinedThreads can run in a side effect so
long as it's joined. It should never run in an unpaused
side-effect.

Drop support for old-style saved grids because it requires
multiple round trips to the main thread. It's been over a
year.

2022-02-08: Fix a bug where interval tree objects were lost
on resize because their entries were nilled too early

2022-02-08: Make VT100ScreenMutableState a linebuffer
delegate

2022-02-08: Fix variable line height in about window

2022-02-08: Never run side effects synchronously. You can
hit this in setConfig: (e.g., when it affects the color map)
but side effects get executed at the end of sync so it's not
a long wait. This might break things but I definitely prefer
this design.

2022-02-08: Update to Xcode 13.2, Swift 5.5

2022-02-08: Make iTermTuple nullability-correct. This forces
fixing up SetUserVariableTrigger.swift.

Make side-effect state into a bitmask instead of a
dictionary because it was wasting 3.5% of cpu on the spam.cc
benchmark.

Add assertions that out-of-order side effects never occur
(i.e., that addSideEffect in joined threads only happens
when no side-effects are queued up).

Fix a bug in swapOnscreenIntervalTreeObjects where its
`temp` tree could get deallocated causing its doppelgangers
not to be removed triggering an assertion when later adding
them to the saved tree.

2022-02-07: Add optimizations: make marking dirty in grid
faster. Change line buffer copy to merge by dropping from
head/tail and appending to tail. This is WAY faster and
makes the spam.cc benchmark finish in under 3 seconds :)

2022-02-07: Don't use fastpath
(CGContextShowGlyphsAtPositions) to draw powerline glyphs
because core text (CTFontDrawGlyphs) does it differently and
better. Issue 10120

2022-02-06: Put all metal drivers on the same queue. This
fixes a data race that tsan found in TexturePageCollection
(and friends) because they are a global data structure with
no locking. Perhaps this is the memory corruption bug I have
been chasing for so many years?

2022-02-06: Fix data race on _dcsHooked

2022-02-05: Update shell integration

2022-02-05: Fix incorrect use of mutableState from main
thread in search. Invalidate tail find timer when dirty
cells are found. This fixes a bug where two -refresh calls
in the same spin of the runloop broke tail find (because it
thought it was still finding so it declined to search even
though some search results were removed).

2022-02-04: Fix selecting menu items in pointer action

2022-02-04: Downgrade todo to comment

2022-02-04: Enable thread sanitizer

2022-02-04: Remove resolved TODO

2022-02-04: Fix leak of AATree

2022-02-04: Fix a bug where hidden annotations would briefly
flash visible

2022-02-04: Remove already-addressed todo

2022-02-04: Remove already-addressed TODOs

2022-02-04: Nil out interval tree object entries when
removing all. I think this caused the assertion I kept
hitting when adding an object back later (the doppelganger
had a nonnil entry)

2022-02-04: Remove already-addressed todos

2022-02-04: Remove already-addressed TODO

2022-02-04: Add missing delegate methods

2022-02-03: Allow requesting Bluetooth permission (#457)

Add NSBluetoothAlwaysUsageDescription.  Command line
applications that use CoreBluetooth will crash with SIGABRT
if this is not present in info.plist.  2022-02-03: Reduce
calls to screenDidReceiveLineFeed

2022-02-03: Resolve TODO

2022-02-03: Remove todo. I already moved
removeInaccessibleIntervalTreeObjects to didSynchronize

2022-02-03: Remove some TODOs. We are already limiting
temporaryDoubleBuffer.drawSavedGrid=YES and haveScrolled=NO
to when resetting scrollback overflow, which weakly relates
to when draws happen. I think it's good enough but real
world experience will tell for sure. I also don't think
there's any reason to update the grid's currentDate in
didSynchronize because it's set prior to executing a vector
of tokens and I don't see anywhere that we mark dirty just
after synchronizing.

2022-02-03: Use absolute ranges when computing intervals.
This behaves better when intervals are before the start of
history. Remove inaccessible interval tree objects at the
end of sync. After syncing, run any pending side-effects.

2022-02-03: Add VT100GridAbsCoordRangeContainsAbsCoord

2022-02-02: Add debug logs

2022-02-02: Fix typo

2022-02-02: Hold the lineblock mutex during mutations. There
was a race between cowCopy nilling the mutation certificate
and willModify allocating it. Not to mention writing to
memory is unsafe while copying it.

2022-02-02: Document why trigger checks should be done just
before sync

2022-02-02: Address TODO

2022-02-02: Pass dimmingAmount through screen config. Remove
some todos

2022-02-02: Fix some warnings

2022-02-02: Actually you don't need to pause to send a
report because all reports are sent through a side-effect.

2022-02-02: Finish auditing side effects for runloops.
Dispatch async as needed. Also caught a few places that
needed to be paused.

2022-02-02: Avoid calling screenDidAddMark if not alerting.

Use the mark's doppelganger in
screenDidUpdateReturnCodeForMark:remoteHost: and
screenCommandDidExitWithCode:mark:

Prevent tmux tokens from having runloops in side effects.

Use a joined side effect for screenDidAddNote:focus: because
it will call -refresh.

2022-02-01: Remove NSLog

2022-02-01: Speed up querying for terminfo values. Fix
colors, Co, and RGB.

2022-01-31: Ensure that we never join from a non-paused
side-effect.

2022-01-30: Remove more join from side effects

2022-01-30: Remove incorrect assertions. You can't run code
in this class from a side-effect.

2022-01-30: Outlaw joining from side-effects to avoid
out-of-order side-effects.

Fix a bug where grids didn't get merged if udpateDirty ran
while state is shared between mutable&immutable.

2022-01-29: remove debug code

2022-01-29: While the main and mutation threads are joined,
keep VT100Screen.state exactly equal to
VT100Screen.mutableState. A bit of NSProxy magic ensures
that only interval tree doppelgangers are accessible through
.state and that iTermColorMap's delegate remains the mutable
state in state.colorMap.delegate. Clean up various other
odds and ends

2022-01-29: Pass resetOverflow to didSynchronize so it is
always called

2022-01-29: Oops, missed one line in the last commit

2022-01-29: Add some todos, add missing return

2022-01-27: Remove todo

2022-01-27: Delete PPC code

2022-01-27: When you do ED 2 (CSI 2 J) in alternate screen
when visible marks are present and the screen is empty (or
marks occur below the last non-empty line), scroll the marks
off the screen.

2022-01-27: Avoid updating untouched parts of the config

2022-01-27: Clean up some todos. Reuse triggers when
reloading profile when possible

2022-01-27: Create a general method for idempotent side
effects and use it for setNeedsRedraw and
intervalTreeVisibleRangeDidChange

2022-01-27: Remove todo, make needsRedraw nonatomic

2022-01-27: Remove todo

2022-01-27: Remove todos, don't try to handle token
injection on arbitrary queues

2022-01-27: Remove todos

2022-01-27: Make copying a temporary double buffer cheap
when it hasn't changed.

2022-01-27: Mark grid dirty when restoring

2022-01-27: Move animatedLines to VT100Screen to make
updating VT100ScreenState cheaper

2022-01-27: Make the mark cache track whether it's dirty so
syncing is cheap when it's unchanged

2022-01-27: Remove some todos that have been todone

2022-01-26: Remove dead code

2022-01-26: Avoid copying the colormap on sync. Instead,
mirror changes to the mutable colormap in the immutable one
in side-effects like we do for the interval tree. Refactor
some color-setting code to make it faster. Also fix a hang
on launch when concurrency is disabled.

2022-01-26: Use addPausedSideEffect in
VT100ScreenMutableState+TerminalDelegate

2022-01-26: Prevent reentrant setConfig:

Sync before and after nested joined side effects so that
changes to the colormap are reflected in the delegate's
copy.

Make setMutingAmount and setDimOnlyText be side-effect-free
when no change is made to avoid infinite recursion in
setConfig:.

2022-01-26: Fixes and performance improvements

Move throughput estimation to mutation thread.

Don't use AsciiData asynchronously: that's a USF. Intead,
make a copy before dispatching if logging is needed.

Change how updates from the mutation thread to the main
thread (for the purposes of changing cadence, setting
active, etc.) works. Bundle up info into
VT100ScreenTokenExecutorUpdate and send updates periodically
while input is being handled. The delegate interface in
TokenExecutor for these is also simplified to a single call.

Add maybeHasExpectations to iTermExpect since getting the
array of expectations is slow.

Add low-priority side-effects. They get quued to run but do
not cause an immediate dispatch to the main queue every
time. It uses a PeriodicScheduler to ensure they are
dispatched within 33 ms. This greatly improves performance.

Add PeriodicScheduler to help coalesce repeated operations.
This is similar to iTermRateLimitedUpdate but is quite a bit
simpler and works off the main thread.

Reduce calls to [NSDate date] during mutation since it is
slow.

Add various small optimizations to VT100Grid.

Coalesce calls to intervalTreeVisibleRangeDidChange.

Make performingJoinedBlock a class property to avoid
deadlock when performJoinedBlock is reentrant with two
different screens, as when detaching from tmux.

Avoid mutating nil interval tree objects. I am sad that
despite nullability annotations the compiler can't catch
this.

Avoid checking if termType contains screen on every token
because doing so is slow.

2022-01-25: Performance improvements

2022-01-25: Avoid calling logging side-effects or creating
strings while appending ascii data if they are not needed.

2022-01-25: Avoid repeatedly doing a slow check for CPU type

2022-01-25: Fix assert on launch

2022-01-25: Make trigger delegate callsbacks go through
TokenExecutor's scheduler when async to avoid unpausable
work accruing on the mutation queue.

Fix a data race - intervals were shared between the mutable
and derivative interval trees.

Improve MutableAtomicObject by adding a set method.

Prevent re-entrant side effects. I noticed you could get two
alerts from alert triggers at the same time because the
runloop allows events (which could kick off high-pri tasks,
which could themselves have side-effects) to run while the
main queue is blocked. This means side effects could
potentially run long after syncing state. Keep an eye out
for problems with this.

2022-01-25: Enable concurrent VT100ScreenState use/mutation
by advanced pref. Fix various data races and add assertions.

2022-01-25: Make triggers run deletate methods on the right
queue

2022-01-25: Port more of ScreenChar to Swift

2022-01-25: Port more of ScreenChar to Swift

2022-01-25: Move screenchar logic for complex strings into a
new class that allows concurrent access

2022-01-25: Make iTermImageInfoReading to isolate the
mutation points. The class was already designed to be used
concurrently, so this is just sugar.

2022-01-25: Move iTermTokenExecutorDelegate to
VT100ScreenMutableState

2022-01-25: Big cleanup.

* ARCify VT100WorkingDirectory, iTermImageInfo, iTermMark.
* Move code->iTermImageInfo map into a new class,
ImageRegistery.  * Make various classes immutable
(VT100RemoteHost, VT100WorkingDirectory,
iTermCapturedOutputMark, iTermImageMark) * Make LineBlock's
observers an ObjC array because it's impossible to reason
about object lifetimes in C++ data structures.  * Fix a leak
of metadata line copied line blocks.  * Fix use after
dealloc of _shell when replacing a terminated session.  *
Fix leak of VT100ScreenState in sync.  * Don't register
VT100ScreenMark doppelgangers.  * Fix oob write when
changing cusor type while it's in the overflow column * Fix
a race that made restoring images not always work (garbage
collected prematurely)

2022-01-25: Sure PTYTextView's colormap is up to date. Fix
various mis-uses of the interval tree and clean up the code,
renaming it to EventuallyConsistentIntervalTree.

2022-01-25: Checkpoint - everything is broken

2022-01-25: Move IntervalTree.h in project to be with its .m

2022-01-25: Delete dead code

2022-01-25: Move destructivelySetScreenWidth

2022-01-25: remove needless mutation wrapper

2022-01-25: Revert "Move destructivelySetScreenWidth, remove
silly setMayHaveDoubleWidthCharacters wrapper"

This reverts commit
11c06608b4a307d964ed92409f3bd3ed3105a3d9.

2022-01-25: Move destructivelySetScreenWidth, remove silly
setMayHaveDoubleWidthCharacters wrapper

2022-01-25: Move periodic trigger checks (partial line) into
sync

2022-01-25: Remove mutInjectData and delete dead code

2022-01-25: Remove mutGetAndResetHasScrolled

2022-01-25: Move setMaxScrollbackLines

2022-01-25: Delete dead code

2022-01-25: Fix a bug where horizontal cursor movement
didn't cause a redraw.

Fix a bug where the 'reduce flicker' setting was ignored.

Improve the API for double buffering and make it work again.

Fix a bug where tokenExecutorDidHandleInput was called if
there were side-effects but no tokens handled.

Make VT100ScreenState the double-buffer's delegate instead
of VT100Screen.

Tell VT100ScreenState what queue it should be used on so it
can tell the double buffer where to run its timer.

Extend iTermGCDTimer to accept a queue.

2022-01-25: Remove dirty modification from cursor-change
pathway

2022-01-25: Simplify dirty handling in preparation for
making a copy of state

2022-01-25: Get rid of getLineAtScreenIndex

2022-01-25: Move unlimitedScrollback flag to screen state

2022-01-25: Clean up syncing

2022-01-25: Remove dead code

2022-01-25: Move saveToScrollbackInAlternateScreen to screen
config

2022-01-25: Remove dead code

2022-01-25: Move appendToScrollbackWithStatusBar to screen
config

2022-01-25: Delete dead code

2022-01-25: Move normalization to screen config

2022-01-25: Remove mutSetIntervalTreeObserver

2022-01-25: Remove mutSetDelegate

2022-01-25: Remove dead code

2022-01-25: Remove mutSetShouldExpectPromptMarks

2022-01-25: Remove mutScheduleTokenExecution

2022-01-25: Remove dead code

2022-01-25: Remove mutSetExited

2022-01-25: Use joined threads to set dimming amount

2022-01-25: Move muting amount to screen config

2022-01-25: Move minimum contrast to screen config

2022-01-25: Fix some things I missed in the last commit

2022-01-25: Move useSeparateColorsForLightAndDarkMode to
screen config

2022-01-25: Move darkMode to screen config

2022-01-25: Move dimOnlyText to screen config

2022-01-25: Remove mutLoadInitialColorTable

2022-01-25: Remove
mutRestorePreferredCursorPositionIfPossible

2022-01-25: Move find on page state back into VT100Screen.
Move logic into a category.

2022-01-25: Move mutSetFromFrame

2022-01-25: Remove dead code

2022-01-25: Remove mutLineFeed

2022-01-25: Move mutCrlf

2022-01-25: Move
mutNumberOfLinesDroppedWhenEncodingContentsIncludingGrid

2022-01-25: Move mutSetAltScreen

2022-01-25: Move motSetHistory

2022-01-25: Move more resizing code to
VT100ScreenMutableState

2022-01-25: Remove mutAppendScreenChars

2022-01-25: Remove mutAppendStringAtCursor

2022-01-25: Move mutRemoveLastLine

2022-01-25: Remove mutResetTimestamps

2022-01-25: Remove mutClearScrollbackBuffer and
VT100Screen.clearScrollbackBuffer

2022-01-25: Delete dead code

2022-01-25: Delete dead code

2022-01-25: Remove mutClearBuffer and delete dead code

2022-01-25: Move remove mutRemoveAnnotation

2022-01-25: remove dead code

2022-01-25: Move state restoration code

2022-01-25: Wrap addNoteAtCursor with joined threads to
avoid racing w/r/t cursor position

2022-01-25: Remove mutAddNote:

2022-01-25: Remove mutClearFromAbsoluteLineToEnd

2022-01-25: Delete terminal delegate code from VT100Screen,
fix up various inappropriate uses of it

2022-01-25: Remove mutAddMarkStartingAtAbsoluteLine

2022-01-25: Remove mutSetWorkingDirectory

2022-01-25: Remove mutAddNoteWithText:inAbsoluteRnage:

2022-01-25: Add mutateAsynchronously to modify
VT100ScreenMutableState but without blocking until it's done
with its current token. Use it for command-end inference
(useful with trigger-detected prompts).

2022-01-25: Remove dead code

2022-01-25: Remove VT100Screen.terminal. Hurray!!!

2022-01-25: Make sgrCodesForCharacter a class method

2022-01-25: Add terminal state dictionary to
VT100ScreenState so that encoding restoration state doesn't
require using terminal directly. This might be slow.

2022-01-25: Make encoding screen contents use joined threads
to avoid accessing the terminal directly

2022-01-25: Add terminalCharset

2022-01-25: remove terminal from PTYTextView0DataSource

2022-01-25: Use _screen.terminalBracketedPasteMode

2022-01-25: Remove dead code. Goodbye PTYSession.terminal!

2022-01-25: Make resetCharset use joined threads

2022-01-25: Make applescript get answerback string from
profile, not terminal

2022-01-25: Fix return type of
tryToFinishAttachingToMultiserverWithPartialAttachment.

Begin tmux recovery mode in the parser before registering
with tasknotifier so input can be handled correctly as soon
as it arrives. If the session won't actually be a tmux
gateway because we failed to attach to a runnign server,
cancel tmux recovery mode right away.

Pause the token executor before enabling the terminal so
initial setup can complete before the first token is
executed.

Fix a bug in how VT100TmuxParser ignored its first line of
input in recovery mode.

2022-01-25: Use joined threads to reset send modifiers when
restoring an session not attached to a server

2022-01-25: Make naggingControllerDisableBracketedPasteMode
use joined threads

2022-01-25: Use joined thread when permanently disabling
mouse reporting

2022-01-25: Call stopReceivingFile in joined threasd

2022-01-25: Use joined threads in
offerToTurnOffFocusReportingOnHostChange

2022-01-25: Use joined threads when handling response to
turning off mouse reporting announcement

2022-01-25: Use joined threads in
maybeTurnOffPasteBracketing and
maybeResetTerminalStateOnHostChange and setHost:user:

2022-01-25: Add terminalMetaSendsEscape

2022-01-25: Add terminalReceivingFile

2022-01-25: Move mutSetTmuxState

2022-01-25: Fix more terminalBracketedPasteMode that I
missed

2022-01-25: Make printTmuxMessage use joined threads

2022-01-25: Make textViewResetTerminal use joined threads

2022-01-25: Make textViewToggleTerminalStateForMenuItem use
joined threads

2022-01-25: Fix a missed terminalBracketedPasteMode

2022-01-25: Fix a bug where Always and Never didn't work in
the annoucement for paste bracketing oopsies

2022-01-25: Add terminalBracketedPasteMode

2022-01-25: Make tmuxHostDisconnected go through a joined
thread. I removed the dispatch to the tmux queue because
joining the parsing queue is simpler and should be just as
safe. The only risk is that it somehow gets ordered before
some writes on the tmux queue, but I don't think it'll be a
problem because those clients get shut down and the writes
will just fail with a broken pipe.

2022-01-25: Move setTmuxMode into joined thread. Disable
focus reporting for tmux gateway

2022-01-25: Use terminalReportFocus instead of
terminal.reportFocus

2022-01-25: Make terminalFileShouldStop use terminal in a
joined thread

2022-01-25: Make setEncoding use the existing mutable
terminal

2022-01-25: Make setTermVariable use existing mutable
terminal

2022-01-25: Do setPreferencesFromAddressBookEntry in a
joined block

2022-01-25: Remove
VT100Screen.appendNativeImageAtCursorWithName

2022-01-25: Make appendBrokenPipeMessage use joined threads

2022-01-25: Move VT100Screen.terminate into joined block

2022-01-25: Add missing commas

2022-01-25: Fix copying of VT100Grid and various warnings.
Proxy colormap delegate through VT100ScreenMutableState and
make PTYSession's delegate calls take an immutable colormap
and run as a side-effect

2022-01-25: Expose VT100Terminal's state through VT100Screen
readonly properties

2022-01-25: Move threadedReadTask to VT100ScreenMutableState

2022-01-25: Move ownership of echoProbe to
VT100ScreenMutableState

2022-01-25: Move ownership of terminal from PTYSession to
VT100ScreenMutableState

2022-01-25: Move misplaced methods

2022-01-25: Move terminalSoftAlternateScreenModeDidChange

2022-01-25: Move terminalPasteboardReceiptEndedUnexpectedly

2022-01-25: Move terminalRequestUpload

2022-01-25: Move terminalDidFinishReceivingFile

2022-01-25: Move terminalKeyReportingFlagsDidChange

2022-01-25: Move terminalDidChangeSendModifiers

2022-01-25: Remove dead code

2022-01-25: Move terminalNeedsRedraw

2022-01-25: Move terminalSetCharset

2022-01-25: Move terminalWillStart/EndLinkWithCode

2022-01-25: Move terminalProtectedMode

2022-01-25: Move terminalProtectedModeDidChangeTo

2022-01-25: Move terminalSelectiveEraseInLine

2022-01-25: Move terminalSelectiveEraseInDisplay

2022-01-25: Move terminalSelectiveEraseRectangle

2022-01-25: Move terminalEraseRectangle

2022-01-25: Move terminalFillRectangle

2022-01-25: Move terminalCopyFrom

2022-01-25: Move toggleAttribute

2022-01-25: Move terminalSetAttribute

2022-01-25: Move terminalDeleteColumns

2022-01-25: Fix warning

2022-01-25: Move terminalInsertColumns

2022-01-25: Move terminalMaximumTheoreticalImageDimension

2022-01-25: Move terminalRestoreColorsFromSlot

2022-01-25: Move terminalSavedColorsSlot

2022-01-25: Move terminalApplicationKeypadModeDidChange

2022-01-25: Move terminalStringForKeypressWithCode

2022-01-25: Move terminalLeftRightRegionString

2022-01-25: Move terminalTopBottomRegionString

2022-01-25: Move terminalIsInAlternateScreenMode

2022-01-25: Move terminalReportKeyUpDidChange

2022-01-25: Move 00~terminalPasteBracketingWillChangeTo01~

2022-01-25: Move terminalReportFocusWillChangeTo

2022-01-25: Move terminalRepeatPreviousCharacter

2022-01-25: Move terminalCustomEscapeSequenceWithParameters

2022-01-25: Move terminalSetColorNamed

2022-01-25: Move terminalPushKeyLabels and
terminalPopKeyLabels

2022-01-25: Move terminalSetLabel

2022-01-25: Move terminalUnicodeVersion

2022-01-25: Move terminalSetUnicodeVersion

2022-01-25: Move terminalCellSizeInPoints

2022-01-25: Move VT100TerminalDelegate impl to category

2022-01-25: Move file download stuff to
VT100ScreenMutableState

2022-01-25: Move terminalSGRCodesInRectangle

2022-01-25: Move terminalScrollRegion

2022-01-25: Add terminalProfileName

2022-01-25: Move terminalChecksumInRectangle

2022-01-25: Move terminalInsertModeDidChangeTo

2022-01-25: Move terminalTypeDidChange

2022-01-25: Move terminalWraparoundModeDidChangeTo

2022-01-25: Move terminalSetShellIntegrationVersion

2022-01-25: Move terminalFinalTermCommand

2022-01-25: Move terminalReturnCodeOfLastCommandWas

2022-01-25: Move a bunch of unimplemented finalterm delegate
methods

2022-01-25: Move terminalAbortCommand

2022-01-25: Make _commandRangeChangeJoiner use the token
executor as its scheduler so the delegate call can run as a
side-effect so that it'll be run before a joined block

2022-01-25: Move terminalCommandDidEnd

2022-01-25: Move terminalCommandDidStart

2022-01-25: Move terminalSetTabStops

2022-01-25: Move terminalTabStops

2022-01-25: Move terminalPromptDidStart

2022-01-25: Sync before running side effects

2022-01-25: Move terminalSetHighlightCursorLine and
terminalClearCapturedOutput. Also change joined blocks to
sync before and after the block

2022-01-25: Move terminalSetCursorVisible

2022-01-25: Move terminalWillAutoWrap

2022-01-25: Move terminalCursorX and terminalCursorY

2022-01-25: Move terminalColorForIndex

2022-01-25: Move terminalCursorVisible

2022-01-25: Move terminalFocusReportingAllowed

2022-01-25: Move terminal delegate methods for setting
colors. This made various problems in joined-thread running
apparent, and it was generally cleaned up and made saner and
more correct.

2022-01-25: Move terminalSetUserVar

2022-01-25: Move terminalSetBadgeFormat

2022-01-25: Move terminalSetBackgroundImageFile

2022-01-25: Move erminalDisinterSession

2022-01-25: Move terminalRequestAttention

2022-01-25: Move terminalCanUseDECRQCRA

2022-01-25: Move terminalIsTrusted

2022-01-25: Move terminalSetPasteboard,
terminalAppendDataToPasteboard,
terminalCopyBufferToPasteboard

2022-01-25: Move terminalAddNote

2022-01-25: Move terminalProfileShouldChangeTo

2022-01-25: Move terminalClearBuffer

2022-01-25: Move terminalClearScrollbackBuffer

2022-01-25: Move terminalSetProxyIcon

2022-01-25: Move terminalStealFocus

2022-01-25: Move terminalSaveScrollPositionWithArgument

2022-01-25: Move terminalClearScreen

2022-01-25: Move terminalSetWorkingDirectoryURL and
terminalCurrentDirectoryDidChangeTo

2022-01-25: Move terminalSetRemoteHost. Delete dead code.
Reindent stuff at xcode's whim

2022-01-25: Move terminalShowPrimaryBuffer

2022-01-25: Move terminalIsShowingAltBuffer

2022-01-25: Move terminalUseColumnScrollRegion

2022-01-25: Move code to show alt screen to
VT100ScreenMutableState. This forces it to become
VT100GridDelegate and to pull in some state restoration
code.

2022-01-25: Avoid calling
VT100GridDelegate.gridSizeDidChange during initialization

2022-01-25: Move terminalMouseModeDidChangeTo

2022-01-25: Move terminalWidth/Height

2022-01-25: Move terminalSynchronizedUpdate and fix test

2022-01-25: Move terminalHandleTmuxInput

2022-01-25: Move terminalStartTmuxModeWithDCSIdentifier

2022-01-25: Move terminalPostUserNotification

2022-01-25: Move terminalPush/PopCurrentTitleForWindow

2022-01-25: Move terminalWindowTitle, fix terminalIconTitle
to respect allowTitleReporting and terminalIsTrusted

2022-01-25: Move terminalIconTitle

2022-01-25: Move terminalScreenHeightInCells,
terminalScreenWidthInCells

2022-01-25: Move terminalWindowWidth/HeightInPixels

2022-01-25: Move terminalWindowTopLeftPixelCoordinate

2022-01-25: Move terminalWindowIsMiniaturized

2022-01-25: Move terminalScrollUp

2022-01-25: Move terminalScrollDown

2022-01-25: Move terminalRaise

2022-01-25: Move terminalMiniaturize

2022-01-25: Move terminalMoveWindowTopLeftPointTo

2022-01-25: Move terminalSetPixelWidth:height: to
VT100ScreenMutableState

2022-01-25: Move terminalDeleteCharactersAtCursor to
VT100ScreenMutableState

2022-01-25: Move terminalDeleteCharactersAtCursor to
VT100ScreenMutableState

2022-01-25: Move terminalInsertBlankLinesAfterCursor to
VT100ScreenMutableState

2022-01-25: Move terminalShiftRight to
VT100ScreenMutableState

2022-01-25: Move terminalShiftLeft to
VT100ScreenMutableState

2022-01-25: Move terminalSetRows:andColumns: to
VT100ScreenMutableState

2022-01-25: Move terminalInsertEmptyCharsAtCursor to
VT100ScreenMutableState

2022-01-25: Move terminalDidFinishReceivingPasteboard to
VT100ScreenMutableState. Also clear the pasteboard before
putting a string on it

2022-01-25: Move begin/append copy to clipboard to
VT100ScreenMutableState

2022-01-25: Move terminalPasteString to
VT100ScreenMutableState. Also make navigating to prefs
easier when copying is disallowed

2022-01-25: Handle newlines in icon titles correctly (do not
include in title, since it should delimit the subtitle)

2022-01-25: Move terminalSetSubtitle to
VT100ScreenMutableState

2022-01-25: Move terminalSetIconTitle to
VT100ScreenMutableState

2022-01-25: Reorder setting delegates to avoid having a
token executor without a delegate after restoring a closed
session. Nil out the token executor when removing the
terminal.

2022-01-25: Move terminalSetWindowTitle to
VT100ScreenMutableState

2022-01-25: Move the rest of printing code to
VT100ScreenMutableState

2022-01-25: Move printing code to VT100ScreenMutableState

2022-01-25: Move terminalEraseCharactersAfterCursor to
VT100ScreenMutableState

2022-01-25: Move terminalAdvanceCursorPastLastColumn to
VT100ScreenMutableState

2022-01-25: Move terminalBackTab to VT100ScreenMutableState

2022-01-25: Move terminalRemoveTabStopAtCursor to
VT100ScreenMutableState

2022-01-25: Update terminal-originated resizing and all
resetting to be parallelizable. To accomplish this we
introduce joining, where the main thread and mutation thread
can be safely mutated synchronously - effectively a critical
region.

2022-01-25: Move API for resizing to
VT100ScreenMutableState+Resizing

2022-01-25: Move reallySetSize to
VT100ScreenMutableState+Resizing. Also move
compactLineDumpWithHistoryAndContinuationMarksAndLineNumbers
to VT100ScreenState

2022-01-25: Move didResizeToSize to
VT100ScreenMutableState+Resizing

2022-01-25: Move updateAlternateScreenIntervalTreeForNewSize
to VT100ScreenMutableState+Resizing

2022-01-25: Move
subSelectionsAfterRestoringPrimaryGridWithCopyOfAltGrid to
VT100ScreenMutableState+Resizing

2022-01-25: Move subSelectionsForNewSize to
VT100ScreenMutableState+Resizing

2022-01-25: Move addObjectsToIntervalTreeFromTuples to
VT100ScreenMutableState+Resizing

2022-01-25: Move computeRangeFromOriginalLimit to
VT100ScreenMutableState+Resizing

2022-01-25: Move restorePrimaryGridWithLineBuffer to
VT100ScreenMutableState+Resizing

2022-01-25: Move fixUpPrimaryGridIntervalTreeForNewSize to
VT100ScreenMutableState+Resizing

2022-01-25: Move replacementIntervalTreeForNewWidth to
VT100ScreenMutableState+Resizing

2022-01-25: Move
subSelectionsWithConvertedRangesFromSelection to
VT100ScreenMutableState+Resizing

2022-01-25: Move convertRange to
VT100ScreenMutableState+Resizing

2022-01-25: Move prepareToResizeInAlternateScreenMode to
VT100ScreenMutableState+Resizing

2022-01-25: Fix jobs tool showing pid 0 when session is
terminated and not getting the new pid when it is restarted

2022-01-25: Move mutSwapNotes to VT100ScreenMutableState

2022-01-25: Move intervalTreeObjectsWithUsedHeight to
VT100ScreenMutableState+Resizing

2022-01-25: Move intervalTreeObjectMayBeEmpty to
VT100ScreenMutableState+Resizing

2022-01-25: Move subSelectionTuplesWithUsedHeight to
VT100ScreenMutableState+Resizing

2022-01-25: Move positionRangeForCoordRange to
VT100ScreenMutableState+Resizing

2022-01-25: Move trimSelectionFromStart to
VT100ScreenMutableState+Resizing

2022-01-25: Move runByTrimmingNullsFromRun to
VT100ScreenMutableState+Resizing

2022-01-25: Move appendScreenToScrollback to
VT100ScreenMutableState+Resizing

2022-01-25: Use mutableState from
performBlockWithJoinedThreads in reallySetSize

2022-01-25: Pass VT100ScreenMutableState to
performBlockWithJoinedThreads block

2022-01-25: Move willSetSizeWithSelection to
VT100ScreenMutableState

2022-01-25: Implement performBlockWithJoinedThreads, use it
in resizing code.

2022-01-25: Move interval sanity checks to
VT100ScreenMutableState+Resizing

2022-01-25: Move call to screenRangeOfVisibleLines out of
VT100Screen+Resizing

2022-01-25: Move shouldSetSizeTo to VT100ScreenMutableState

2022-01-25: Move commandDidEndWithRange to
VT100ScreenMutableState

2022-01-25: Introduce resizing category on
VT100ScreenMutableState

2022-01-25: Move terminalRemoveTabStops to
VT100ScreenMutableState

2022-01-25: Move terminalLineDrawingFlagForCharset to
VT100ScreenMutableState

2022-01-25: Make changes to cursor type and blink pause
token execution so reports will be consistent

2022-01-25: Move terminalResetCursorTypeAndBlink to
VT100ScreenMutableState

2022-01-25: Move terminalGetCursorInfoWithCompletion to
VT100ScreenMutableState

2022-01-25: Move terminalCursorIsBlinking to
VT100ScreenMutableState. Make its result a promise we can
asynchronously check if the cursor is blinking

2022-01-25: Move terminalSetCursorBlinking to
VT100ScreenMutableState

2022-01-25: Move terminalSetCursorType to
VT100ScreenMutableState

2022-01-25: Move code for resetting the terminal into
VT100ScreenMutableState

2022-01-25: Move terminalForwardIndex and terminalBackIndex
to VT100ScreenMutableState

2022-01-25: Move terminalReverseIndex to
VT100ScreenMutableState

2022-01-25: Move terminalSetTabStopAtCursor to
VT100ScreenMutableState

2022-01-25: Move terminalEraseLineBeforeCursor:after: to
VT100ScreenMutableState

2022-01-25: Move terminalEraseInDisplayBeforeCursor to
VT100ScreenMutableState

2022-01-25: Move a bunch of code for erasing things into
VT100ScreenMutableSTate

2022-01-25: Move terminalSetScrollRegionTop:bottom: to
VT100ScreenMutableState

2022-01-25: Move terminalRelativeCursorX and
terminalRelativeCursorY to VT100ScreenMutableState

2022-01-25: Move terminalShowTestPattern to
VT100ScreenMutableState

2022-01-25: move terminalSendReport to
VT100ScreenMutableState

2022-01-25: Move terminalReportVariableNamed to
VT100ScreenMutableState and combine various delegate APIs to
reduce round trips across threads

2022-01-25: Revert "Move terminalShouldREportVariable to
VT100ScreenMutableState"

This reverts commit
76b3bf7efb74e22a233f910700de1bbc8c59caab.

2022-01-25: Move terminalShouldREportVariable to
VT100ScreenMutableState

2022-01-25: Move terminalShouldSendReport to
VT100ScreenMutableState

2022-01-25: Move terminalMoveCursorToX:y: to
VT100ScreenMutableState

2022-01-25: Move terminalCursorUp to VT100ScreenMutableState

2022-01-25: Fix warnigns

2022-01-25: Move terminalCursorRight to
VT100ScreenMutableState

2022-01-25: Move terminalCursorDown to
VT100ScreenMutableState

2022-01-25: Move cursorLeft to VT100ScreenMutableState

2022-01-25: Move tab and linefeed to
VT100ScreenMutableState, and fix publishing for filters
which used freed memory

2022-01-25: Move terminalBackspace to
VT100ScreenMutableState

2022-01-25: Move terminalRingBell to VT100SCreenMutableSTate

2022-01-25: Move terminalAppendAsciiData to
VT100ScreenMutableState

2022-01-25: Unbreak plaintext logging. Move
terminalAppendString to VT100Screen+MutableState which is
starting to implement VT100TerminalDelegate

2022-01-25: Move trigger evaluation into
VT100ScreenMutableState

2022-01-25: Pause token execution for invoke trigger and
evaluating interpolated strings

2022-01-25: Make VT100ScreenMutableState implement
triggerSession methods

2022-01-25: Move ownership of token executor to
VT100ScreenMutableState. Make changing remotehost pause
token execution so APS has a chance to run before any more
tokens are parsed.

2022-01-25: Refactor token execution into TokenExecutor. It
adds 'pausing' as a feature, which lets the mutation queue
stop handling new tokens until a trigger's side effects are
complete. For example, when the remote host changes we want
automatic profile switching to run before handling the next
token (which might cause different triggers to run if the
profile changes)

2022-01-25: Eliminate Trigger from CapturedOutput. Serialize
its command as a string. This does break state restoration
for captured output commands, unfortunately.

2022-01-25: Make VT100ScreenMutableState conform to
iTermTriggerScopeProvider

2022-01-25: Make VT100ScreenMutableState conform to
iTermTriggerSession. For now it's just an adapter to
PTYSession where the real impl is.

2022-01-25: PTYTriggerEvaluatorDataSource shouldn't derived
form PTYTextViewDataSource because it's freaking huge.
Define a narrowly tailored protocol instead.

2022-01-25: Move -PTYTriggerEvaluatorDelegate to
VT100ScreenMutableState

2022-01-25: Split out
triggerSideEffectCurrentDirectoryDidChange

2022-01-25: Add missing method to header

2022-01-25: Fix nullability annotations in
VT100ScreenDelegate.h

2022-01-25: Add enableTriggersInInteractiveApps to
VT100ScreenConfiguration. It'll be needed later when trigger
evaluation happens in VT100ScreenMutableState

2022-01-25: Move append methods to VT100ScreenMutableState

2022-01-25: Move softAlternateScreenModeDidChange to
VT100ScreenMutableState

2022-01-25: Move stringLineAsStringAtAbsoluteLineNumber to
VT100ScreenMutableState

2022-01-25: Move getLineAtIndex and
getLineAtIndex:withBuffer to VT100ScreenMutableState

2022-01-25: Move linkTextInRange to VT100ScreenMutableState

2022-01-25: Move highlightTextInRange to
VT100ScreenMutableState

2022-01-25: Split out setReturnCodeOfLastCommand

2022-01-25: Move saveCursorLine to VT100ScreenMutableState

2022-01-25: Move highlightRun to VT100ScreenMutableState

2022-01-25: Move linkRun:withURLCode to
VT100ScreenMutableState

2022-01-25: Move mutSetCommandStartCoord to
VT100ScreenMutableState

2022-01-25: Move mutAddNote:inRange:focus to
VT100ScreenMutableState

2022-01-25: Move comment

2022-01-25: Make trigger evaluator not depend on nagging
controller

2022-01-25: Remove dead code

2022-01-25: Split out
triggerSideEffectSetValue:forVariableNamed:

2022-01-25: Split out triggerSideEffectInvokeFunctionCall

2022-01-25: Split out triggerSideEffectSetTitle

2022-01-25: implement triggerSideEffectVariableScope

2022-01-25: Split out triggerWriteTextWithoutBroadcasting

2022-01-25: Split out
triggerSideEffectRunBackgroundCommand:pool:

2022-01-25: Split out
triggerSideEffectOpenPasswordManagerToAccountName

2022-01-25: Split out triggerSideEffectStopScrollingAtLine

2022-01-25: Split out
triggerSideEffectPostUserNotificationWithMessage

2022-01-25: Split out triggerSideEffectMakeFirstResponder

2022-01-25: Split out
triggerSideEffectLaunchCoprocessWithCommand

2022-01-25: Split triggerSideEffectDidCaptureOutput out

2022-01-25: Move guts of
triggerSessionShowShellIntegrationRequiredAnnouncement to
triggerSideEffectShowShellIntegrationRequiredAnnouncement

2022-01-25: Remove unneeded protocol method

2022-01-25: Implement
triggerSideEffectShowCapturedOutputToolNotVisibleAnnouncementIfNeeded

2022-01-25: Implement triggerSideEffectRingBell

2022-01-25: Remove triggerSideEffectReveal from protocol,
not used any mroe

2022-01-25: Delete dead reveal-session-for-triggers code

2022-01-25: Add iTermTriggerSideEffectExecutor and begin
implementing its methods

2022-01-25: Update iTermExpect to work in a mutation-thread
world. See notes in iTermExpect.h for how it is meant to be
used.

2022-01-25: Make iTermURLStore thread-safe and fix how it
encodes refcounts to use secure coding properly

2022-01-25: Indentation fix

2022-01-25: Make lastRemoteHost a protocol

2022-01-25: Move some code around to match move_triggers
branch

2022-01-25: Fix call to screenCurrentHostDidChange on
restoration to occur after interval tree deserialization. It
was done weirdly early for a reason that is no longer valid
- that you'd get a warning about mouse reporting being left
on. That is not a problem because the previous remote host
is nil.

2022-01-25: Move code to set remote host into
VT100ScreenMutableState.

2022-01-25: Remove dead code

2022-01-25: Fix wrong directory used when fetching working
directory after getting an empty path (although I doubt this
code is actually reached in production - I had to use a
weird OSC 7 url to reproduce it)

2022-01-25: Move code to set the current working directory
into VT100ScreenMutableState

2022-01-25: Fix return value of SetUserVariableTrigger so it
doesn't stop evaluation

2022-01-25: Indentation fix

2022-01-25: Indentation fix

2022-01-25: Move trigger command running to triggerSession
delegate to facilitate moving trigger evaluation off the
main thread

2022-01-25: Indentation fix

2022-01-25: Indentation fix

2022-01-25: Move alert rate limiting into trigger session
since rate limits must be used only on the main thread.

2022-01-25: Simplify triggerSession methods for captured
output announcement

2022-01-25: Update annotation trigger's delegate API to
split creating the annotation (which can be done on the
mutation thread) from setting its value (which must be done
on the main thread).

2022-01-25: Move alert-showing logic into
iTermTriggerSession method

2022-01-25: Expose iTermPromise.hasValue

2022-01-25: Use scope provider interface in triggers. This
will be useful when we have to switch threads to access
scope.

2022-01-25: Make iTermExpectation possible to use in a world
with a mutation thread. The mutation thread will use a copy
and reflect changes back to the main thread.

2022-01-25: Make trigger parameter resolution use a promise
instead of a completion block

2022-01-25: Get rid of unsafe array of strings in trigger's
performAction method

2022-01-25: Various improvements to iTermPromise: make it
thread-safe, implement -isEqual: and -hash:, assert that
notification happens at most once, assert seals are
fullfilled/rejected before dealloc, add -hasValue, make the
seal retain the promise.

2022-01-25: Move commandRange into VT100ScreenMutableState
and call screenCommandDidChangeWithRange asynchronously

2022-01-25: Move commandRange to VT100ScreenMutableState

2022-01-25: Move promptDidStartAt to VT100ScreenMutableState

2022-01-25: Move setPromptStartLine to
VT100ScreenMutableState

2022-01-25: Move didUpdatePromptLocation to
VT100ScreenMutableState

2022-01-25: Move addMarkOnLine:ofClass: to
VT100ScreenMutableState

2022-01-25: Move addMarkStartingAtAbsoluteLine to
VT100ScreenMutableState

2022-01-25: Move screen config into mutable state

2022-01-25: Replace totalScrollbackOverflow with
cumulativeScrollbackOverflow in mutation paths

2022-01-25: Move removeAnnotation to VT100ScreenMutableState

2022-01-25: Make removing an interval tree object's observer
call a side effect. Fix a bug where it wasn't actually
removed from the minimap because the entry got nilled before
use (yikes)

2022-01-25: Move setNeedsRedraw to VT100ScreenMutableState

2022-01-25: Make it possible to call interval tree observer
methods as a side-effect.

2022-01-25: Move the 1-arg version of
intervalForGridCoordRange to VT100ScreenState

2022-01-25: Move intervalForGridCoordRange:width:linesOffset
to VT100ScreenState

2022-01-25: Move numberOfLines to VT100ScreenState

2022-01-25: Move assignCurrentCommandEndDate to
VT100ScreenMutableState

2022-01-25: Move lastCommandMark to VT100ScreenState

2022-01-25: Move lineNumberRangeOfInterval to
VT100ScreenState

2022-01-25: Move coordRangeForInterval: to VT100ScreenState

2022-01-25: Move -width and -height to VT100ScreenState

2022-01-25: Change some uses of _state to _mutableState in
the mutation category

2022-01-25: Move crlf to VT100ScreenMutableState

2022-01-25: Move appendLineFeed to VT100ScreenMutableState

2022-01-25: Make removing the selection upon scrolling in
alternate screen mode when not appending to history into a
side-effect

2022-01-25: Refactor side effect performing into
VT100ScreenMutableState so it can call it directly

2022-01-25: Eliminate -mutableCurrentGrid

2022-01-25: Make calls to self.cursorX go through
VT100ScreenState

2022-01-25: Make calls to cursorY go through
VT100ScreenState

2022-01-25: Make VT100Screen and its categories access
cumulativeScrollbackOverflow from the correct state variable
instead of self.totalScrollbackOverflow

2022-01-25: Move numberOfScrollbackLines to VT100ScreenState

2022-01-25: Move incrementOverflowBy: to
VT100ScreenMutableState.m

2022-01-25: Fix a bug where the marks minimap wasn't
initialized for new sessions and the minimap wouldn't show
up until the window got resized

2022-01-25: Split VT100ScreenMutableState into a separate
file

2022-01-25: Refactor VT100ScreenState to begin moving logic
into it

2022-01-25: Fix some warnings, prefix all todo warnings with
TODO:
